<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Minecraft Server Files Generator</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top left, #2c3e50, #1a252f);
      color: #ecf0f1;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
      max-width: 1200px;
      width: 100%;
      justify-content: center;
      align-items: stretch;
    }
    .container {
      flex: 1;
      min-width: 300px;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .info-box {
    background-color: #273747;
    border-left: 5px solid #00e6ac;
    color: #ecf0f1;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    display: flex;
    flex-direction: column;
    gap: 20px;
    }
    .info-box ol {
    padding-left: 20px;
    margin: 0;
    }
    .info-box li {
    margin-bottom: 12px;
    line-height: 1.7;
    }

    .info-box h2 {
      margin-top: 0;
      font-size: 20px;
      color: #00e6ac;
    }
    .info-box a {
      color: #00e6ac;
      text-decoration: underline;
    }
    .info-box code {
      background: #1a252f;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      color: #ffffff;
    }
    .container {
      background: #1e2a38;
      animation: fadeIn 1s ease;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #00e6ac;
      text-align: center;
    }
    input[type="file"],
    button {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 15px;
    }
    input[type="file"] {
      background: #293b4a;
      color: white;
      border: 1px solid #555;
    }
    button {
      background-color: #00e6ac;
      border: none;
      font-weight: bold;
      color: #000;
      cursor: pointer;
    }
    button:hover {
      background-color: #00c99b;
    }
    .progress-container {
      background: #34495e;
      height: 14px;
      border-radius: 8px;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      background: #00e6ac;
      height: 100%;
      width: 0%;
      transition: width 0.2s ease-in-out;
    }
    #status {
      margin-top: 10px;
      font-size: 14px;
      min-height: 20px;
      text-align: center;
    }
    #log {
      margin-top: 20px;
      max-height: 250px;
      overflow-y: auto;
      background: #121a22;
      border-radius: 8px;
      padding: 10px;
      font-size: 13px;
      white-space: pre-wrap;
      font-family: monospace;
    }
    #log div {
      margin-bottom: 4px;
      padding: 2px 0;
    }
    #log div.error {
      color: #ff6b6b;
    }
    #log div.success {
      color: #51cf66;
    }
    #log div.info {
      color: #339af0;
    }
    #log div.warning {
      color: #ffd43b;
    }
    .log-controls {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    .log-controls button {
      width: auto;
      padding: 6px 12px;
      margin-bottom: 0;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="info-box">
    <h2>üßµ Quilt Server Setup</h2>
    <p><strong>‚úÖ Automatic Installer Download</strong></p>
    <p>The Quilt installer will be automatically downloaded for you. No manual upload required!</p>
    <ol>
    <li>Select your <code>.mrpack</code> file below.</li>
    <li>Click the <strong>Generate Server Files</strong> button to start the setup process.</li>
    <li>The Quilt installer will be automatically downloaded and used.</li>
    <li>Wait for the process to complete ‚Äî progress will be shown below the button.</li>
    <li>Once complete, your server files will download as a ZIP file.</li>
    </ol>
    </div>
    <div class="container">
      <h1>üßµ Quilt Server Setup</h1>
      <form id="uploadForm" enctype="multipart/form-data">
        <label>
          <strong>.mrpack file</strong><br/>
          <input type="file" name="mrpack" accept=".mrpack" required />
        </label>
        <br/><br/>
        <p style="color: #51cf66; font-size: 14px;">‚úÖ Quilt installer will be downloaded automatically</p>
        <button type="submit">Generate Server Files</button>
      </form>
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div id="status"></div>
      <div id="log"></div>
      <div class="log-controls">
        <button id="copyLogs">üìã Copy Logs</button>
        <button id="clearLogs">üóëÔ∏è Clear Logs</button>
      </div>
    </div>
  </div>
<script>
  const form = document.getElementById("uploadForm");
  const progressBar = document.getElementById("progressBar");
  const progressContainer = document.getElementById("progressContainer");
  const status = document.getElementById("status");
  const log = document.getElementById("log");
  let logStream = null;
  let logsExpanded = false;
  
  function getLogClass(message) {
    if (message.includes("‚ùå") || message.includes("Error") || message.includes("Failed")) {
      return "error";
    } else if (message.includes("‚úÖ") || message.includes("Success") || message.includes("Complete")) {
      return "success";
    } else if (message.includes("‚ö†Ô∏è") || message.includes("Warning")) {
      return "warning";
    } else {
      return "info";
    }
  }
  
  function logMessage(message) {
    const time = new Date().toLocaleTimeString();
    const entry = document.createElement("div");
    entry.className = getLogClass(message);
    entry.textContent = `[${time}] ${message}`;
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
  }
  
  function startLogStream(requestId) {
      if (logStream) {
          logStream.close();
      }
      logStream = new EventSource(`/api/logs/${requestId}`);
      logStream.onmessage = (event) => {
          // Make sure we're not getting empty messages
          if (event.data && event.data.trim()) {
              logMessage(event.data);
          }
      };
      logStream.onerror = () => {
          logMessage("‚ùå Log stream closed.");
          stopLogStream();
      };
      // Add a connection open handler
      logStream.onopen = () => {
          logMessage("üì° Connected to log stream.");
      };
  }
  
  function stopLogStream() {
    if (logStream) {
      logStream.close();
      logStream = null;
    }
  }
  
  function copyLogs() {
    const lines = Array.from(log.children).map(div => div.textContent).join("\n");
    navigator.clipboard.writeText(lines).then(() => {
      logMessage("üìã Logs copied to clipboard.");
    });
  }
  
  function clearLogs() {
    log.innerHTML = "";
    logMessage("üóëÔ∏è Logs cleared.");
  }
  
  function toggleLogsSize() {
    logsExpanded = !logsExpanded;
    if (logsExpanded) {
      log.style.maxHeight = "500px";
      document.getElementById("expandLogs").textContent = "‚¨ÜÔ∏è Collapse Logs";
    } else {
      log.style.maxHeight = "250px";
      document.getElementById("expandLogs").textContent = "‚¨áÔ∏è Expand Logs";
    }
  }
  
  form.onsubmit = function (e) {
      e.preventDefault();
      const formData = new FormData(form);
      const requestId = crypto.randomUUID();
      const mrpackFile = form.querySelector('input[name="mrpack"]').files[0];
      if (mrpackFile) {
          localStorage.setItem("mrpackFileName", mrpackFile.name);
          logMessage(`üìÅ Selected .mrpack file: ${mrpackFile.name}`);
      }
      
      logMessage(`‚úÖ Quilt installer will be downloaded automatically`);
      
      progressBar.style.width = "0%";
      progressContainer.style.display = "block";
      status.textContent = "Starting server generation...";
      log.innerHTML = "";
      logMessage("üöÄ Upload started...");
      startLogStream(requestId); // Start log streaming
      
      const xhr = new XMLHttpRequest();
      xhr.open("POST", `/api/generate?request_id=${requestId}`, true);
      xhr.responseType = "text"; // Expect text response to parse JSON
      
      xhr.upload.onprogress = function (e) {
          if (e.lengthComputable) {
              const percent = ((e.loaded / e.total) * 100).toFixed(1);
              progressBar.style.width = percent + "%";
              logMessage(`üì§ Upload progress: ${percent}%`);
          }
      };
      
      xhr.onload = function () {
          stopLogStream(); // Close log stream
          if (xhr.status === 200) {
              try {
                  const data = JSON.parse(xhr.responseText);
                  status.textContent = data.message;
                  logMessage(`‚úÖ Server response: ${data.message}`);
                  
                  if (data.status === "success" && data.download_url) {
                      logMessage(`üîó Download URL: ${data.download_url}`);
                      // Trigger auto-download
                      const link = document.createElement("a");
                      link.href = data.download_url; // Use the provided download URL
                      link.download = "quilt-server.zip"; // Suggested filename for Quilt
                      document.body.appendChild(link);
                      link.click();
                      document.body.removeChild(link);
                      logMessage("‚úÖ Download started!");
                      localStorage.removeItem("mrpackFileName");
                  }
              } catch (e) {
                  status.textContent = "‚ùå Failed to parse server response.";
                  logMessage("‚ùå Error parsing JSON response: " + e.message);
                  logMessage(`üìÑ Raw response: ${xhr.responseText}`);
              }
          } else {
              try {
                  const errorData = JSON.parse(xhr.responseText || '{}');
                  const error = errorData.message || "Unknown error";
                  status.textContent = `‚ùå ${error}`;
                  logMessage(`‚ùå Server error: ${error}`);
                  if (errorData.error) {
                      logMessage(`‚ùå Error type: ${errorData.error}`);
                  }
                  if (errorData.download_link) {
                      logMessage(`üîó Manual download link: ${errorData.download_link}`);
                  }
              } catch (e) {
                  status.textContent = "‚ùå Server error.";
                  logMessage(`‚ùå Failed to parse error response: ${e.message}`);
                  logMessage(`üìÑ Raw response: ${xhr.responseText}`);
              }
          }
      };
      
      xhr.onerror = function () {
          stopLogStream();
          status.textContent = "‚ùå Network error.";
          logMessage("‚ùå Network error during upload.");
      };
      
      xhr.send(formData);
  };
  
  window.onload = function () {
    const savedFileName = localStorage.getItem("mrpackFileName");
    if (savedFileName) {
      logMessage(`‚ÑπÔ∏è Please re-select your .mrpack file: ${savedFileName}`);
    }
  };
  
  document.addEventListener("DOMContentLoaded", () => {
    // Animate sections
    document.querySelectorAll(".section").forEach((el, i) => {
      setTimeout(() => el.style.opacity = "1", i * 150);
    });
    
    // Mobile warning
    if (/Mobi|Android|iPhone/i.test(navigator.userAgent)) {
      const popup = document.createElement("div");
      popup.className = "popup-overlay";
      popup.innerHTML = `
        <div class="popup-box">
            ‚ö†Ô∏è This site is best viewed on a desktop.<br /><br />
            Please switch to desktop mode or use a computer for the best experience.
            <br /><br />
            <button onclick="this.closest('.popup-overlay').remove()">OK</button>
        </div>
      `;
      document.body.appendChild(popup);
    }
    
    // Setup log control buttons
    document.getElementById("copyLogs").onclick = copyLogs;
    document.getElementById("clearLogs").onclick = clearLogs;
    document.getElementById("expandLogs").onclick = toggleLogsSize;
    
    // Initial log message
    logMessage("‚ÑπÔ∏è Ready to generate server files. Please select your .mrpack and Quilt installer files.");
  });
</script>
</body>
</html>