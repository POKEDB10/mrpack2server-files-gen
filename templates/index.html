    <!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="UTF-8">
    <title>Minecraft Server Generator</title>
    <style>
        body {
        margin: 0;
        font-family: 'Segoe UI', sans-serif;
        background: radial-gradient(circle at top left, #2c3e50, #1a252f);
        color: #ecf0f1;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        }

        .container {
        background: #1e2a38;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 12px 30px rgba(0,0,0,0.5);
        width: 100%;
        max-width: 520px;
        animation: fadeIn 1s ease;
        }

        @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
        }

        h1 {
        font-size: 26px;
        margin-bottom: 20px;
        color: #00e6ac;
        text-align: center;
        }

        input[type="file"], button {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 15px;
        }

        input[type="file"] {
        background: #293b4a;
        color: white;
        border: 1px solid #555;
        }

        button {
        background-color: #00e6ac;
        border: none;
        font-weight: bold;
        color: #000;
        cursor: pointer;
        }

        button:hover {
        background-color: #00c99b;
        }

        .progress-container {
        background: #34495e;
        height: 14px;
        border-radius: 8px;
        overflow: hidden;
        display: none;
        }

        .progress-bar {
        background: #00e6ac;
        height: 100%;
        width: 0%;
        transition: width 0.2s ease-in-out;
        }

        #status {
        margin-top: 10px;
        font-size: 14px;
        min-height: 20px;
        text-align: center;
        }

        #log {
        margin-top: 20px;
        max-height: 250px;
        overflow-y: auto;
        background: #121a22;
        border-radius: 8px;
        padding: 10px;
        font-size: 13px;
        white-space: pre-wrap;
        }

        #log div {
        margin-bottom: 4px;
        }
    </style>
    </head>
    <body>
    <div class="container">
        <h1>üöÄ Minecraft Server Files Generator</h1>
        <form id="uploadForm" enctype="multipart/form-data">
        <label>
        <strong>.mrpack file</strong><br/>
        <input type="file" name="mrpack" accept=".mrpack" required />
        </label>
        <br/><br/>
        <button type="submit">Generate Server Files</button>
        </form>
        <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
        </div>
        <div id="status"></div>
        <div id="log"></div>
    </div>
    <div id="quiltPopup" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%);
    background:#fff; padding:20px; border:2px solid #444; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3);
    z-index:9999; width:400px; max-width:90%;">
    <h2 style="margin-top:0;">Quilt Installer Required</h2>
    <p>This modpack uses the <strong>Quilt mod loader</strong>, but you didn‚Äôt upload the Quilt installer.</p>
    <p>To continue:</p>
    <ol>
        <li>Go to <a href="https://quiltmc.org/en/install" target="_blank">quiltmc.org/en/install</a></li>
        <li>Download the <strong>.jar</strong> version of the installer</li>
        <li>Re-upload it in the form below before clicking Generate</li>
    </ol>
    <button onclick="document.getElementById('quiltPopup').style.display='none'" style="margin-top:10px;">Close</button>
    </div>

    <script>
        const form = document.getElementById("uploadForm");
        const progressBar = document.getElementById("progressBar");
        const progressContainer = document.getElementById("progressContainer");
        const status = document.getElementById("status");
        const log = document.getElementById("log");

        function logMessage(message) {
        const time = new Date().toLocaleTimeString();
        const entry = document.createElement("div");
        entry.textContent = `[${time}] ${message}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
        }

        function startLogStream(requestId) {
        const source = new EventSource(`/api/logs/${requestId}`);
        source.onmessage = (event) => {
            logMessage(event.data);
        };
        source.onerror = () => {
            source.close();
            logMessage("‚ùå Log stream closed.");
        };
        }

        form.onsubmit = function (e) {
        e.preventDefault();
        const formData = new FormData(form);
        const requestId = crypto.randomUUID();

        progressBar.style.width = "0%";
        progressContainer.style.display = "block";
        status.textContent = "";
        log.innerHTML = "";
        logMessage("Upload started...");

        // Step 1: check loader type
        fetch("/api/check_loader", {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.loader === "quilt") {
            localStorage.setItem("mrpackFileName", formData.get("mrpack").name);
            window.location.href = "/quilt";
            return;
            }

            // Step 2: continue with actual generation
            const xhr = new XMLHttpRequest();
            xhr.open("POST", `/api/generate?request_id=${requestId}`);
            xhr.responseType = "blob";

            xhr.upload.onprogress = function (e) {
            if (e.lengthComputable) {
                const percent = ((e.loaded / e.total) * 100).toFixed(1);
                progressBar.style.width = percent + "%";
                logMessage(`Upload progress: ${percent}%`);
            }
            };

            xhr.onload = function () {
            if (xhr.status === 200) {
                const blob = xhr.response;
                const downloadUrl = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = downloadUrl;
                link.download = "modded-server.zip";
                link.click();
                status.textContent = "‚úÖ Download started!";
                logMessage("Server generated successfully.");
            } else {
                const text = xhr.responseText;
                try {
                const error = JSON.parse(text);
                status.textContent = "‚ùå " + (error.message || "Server error");
                logMessage("‚ùå Server error: " + (error.message || "Unknown"));

                if (error.popup === "quilt_installer_required") {
                    const popup = document.getElementById('quiltPopup');
                    popup.style.display = 'block';
                    popup.scrollIntoView({ behavior: 'smooth' });
                }
                } catch {
                status.textContent = "‚ùå Unexpected server error.";
                logMessage("‚ùå Unexpected response from server.");
                }
            }
            };

            xhr.onerror = function () {
            status.textContent = "‚ùå Network error.";
            logMessage("‚ùå Network error during upload.");
            };

            startLogStream(requestId);
            xhr.send(formData);
        });
        };

    </script>
    </body>
    </html>
